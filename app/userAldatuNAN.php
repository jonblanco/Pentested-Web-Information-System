
<?php
// Include config file
require_once "Datubasea/DatubaseraKonektatu.php";

// Processing form data when form is submitted
if($_SERVER["REQUEST_METHOD"] == "POST"){

$nan = $_POST['NAN'];
//Aldizkaria datubasean dagoela konprobatu

$sql = "SELECT * FROM formulario WHERE izena = ?";
        
        if($stmt = mysqli_prepare($conexion, $sql)){
            // Bind variables to the prepared statement as parameters
            mysqli_stmt_bind_param($stmt, "s", $erabiltzaile);
            
            // Set parameters
            $erabiltzaile = trim($_POST["erabiltzaile"]);
            
            // Attempt to execute the prepared statement
            if(mysqli_stmt_execute($stmt)){
                /* store result */
                mysqli_stmt_store_result($stmt);
                
                if(mysqli_stmt_num_rows($stmt) > 0){
                    
                    $erabiltzaileV = true;
                    
                } else{
                    
                    echo '<script languaje="javascript">'
			, 'alert("Sartutako erabiltzailea ez dago datubasean");'
			, 'window.location="userAldatuNAN.php";'
			, '</script>';
			$erabiltzaileV = false;
                }
            } else{
                echo "Al parecer algo sali√≥ mal.";
            }
            }
            

	//NAN-a egokia dela konprobatu
	$letra = substr($nan, -1);
	$numeros = substr($nan, 0, -1);
	if ( substr("TRWAGMYFPDXBNJZSQVHLCKE", $numeros%23, 1) == $letra && strlen($letra) == 1 && strlen ($numeros) == 8 ){
		$nanV = true;
	}else{
		echo '<script languaje="javascript">'
			, 'alert("Sartutako NAN-a ez da egokia");'
			, 'window.location="userAldatuNAN.php";'
			, '</script>';
		$nanV = false;
	}


	//Aldaketa datubasean egin

	if($erabiltzaileV && $nanV){
        
        // Prepare an insert statement
        $sql = "UPDATE formulario SET NAN='$nan' WHERE IZENA ='$erabiltzaile';";

        if(mysqli_prepare($conexion, $sql)){
            
            // Attempt to execute the prepared statement
            if(mysqli_query($conexion,$sql)=== true){
                // Redirect to login page
                echo '<script languaje="javascript">'
                ,'alert("Aldaketa egin da");'
		, 'window.location="userAldatuNAN.php";'
		, '</script>';
            } else{
                echo '<script languaje="javascript">'
                ,'alert("Zerbait txarto atera da, saiatu berriro");'
                , 'window.location="userAldatuNAN.php";'
		, '</script>';
            }
        }else{
        
        	echo '<script languaje="javascript">'
                ,'alert("Zerbait txarto atera da, saiatu berriro");'
                , 'window.location="userAldatuNAN.php";'
		, '</script>';
        	
        }
         
    }
    
    // Close connection
    mysqli_close($conexion);
}
?>




<!DOCTYPE html>
<HTML> 	  	 
  	<HEAD> 	 
  	</HEAD> 	 
  	<BODY> 	 
      <div class="ignite-cta text-center"  >
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <a class="ignite-btn"> Hemen erabiltzaile baten NAN-a aldatu ahalko duzu:</a>

<section class="subscribe text-center" id="formul">
<div class="container" id="formulario">
   <form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post">
     <table width="2000" border="0"> 
       <tr> 
         
         <td><span class="cnt"> 
           <p>Erabiltzailea<input name="erabiltzaile" type="text" class="txtlogin" value="<?php echo $erabiltzaile; ?>" size="20" placeholder="Sartu NAN aldatu nahi duzun erabiltzailea" required/> </p>
         </span></td> 
       </tr> 
       <tr> 
        
         <td><span class="cnt"> 
         <p>NAN<input type="text" name="NAN" value="<?php echo $nan; ?>" placeholder="99999999Z" required></p>
	 </span></td> 
         
     </table> 
     
     <input value="Sartu" target="_parent" type="submit" class="boton"/> 
     <input type="reset" name="Ezabatu" id="Borrar" value="Reset" class="boton" />
     
</form> 
</div>
</section>





              </div>
            </div>
          </div>
        </div>
        <!DOCTYPE html>
          <html>
            <head>
              <title>mostrar datos</title>
            </head>
            <body>
              <br>
                  <table class="table table-striped">
                      <thead>
		                    <tr>
			                    <th>IZEN ABIZENAK</th>
			                    <th>NAN</th>
			                    <th>TLF</th>
                          <th>JAIOTZE DATA</th>
                          <th>EMAIL</th>	
		                  </tr>
		                </thead>
                    
  
                    
                    <?php
                    include 'Datubasea/DatubaseraKonektatu.php';
                    $sql="SELECT * from formulario";
                    $result=mysqli_query($conexion,$sql);
                    
                    while ($mostrar=mysqli_fetch_array($result)){
                    ?>
                    
                    <tr>
                      <td><div contenteditable><?php echo $mostrar['IZENA']; ?></div></td>
                      <td><div contenteditable><?php echo $mostrar['NAN']; ?></div></td>
                      <td><div contenteditable><?php echo $mostrar['TLF']; ?></div></td>
                      <td><div contenteditable><?php echo $mostrar['JAIOTZEDATA']; ?></div></td>
                      <td><div contenteditable><?php echo $mostrar['EMAIL']; ?></div></td>
                    </tr>
                  <?php
                  }
                    ?>

              </table>
            </body>
            <div class="ignite-cta text-center" onclick= window.location="gureOrrikurratua2.php";  >
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <a class="ignite-btn">Klik hemen orrialde nagusira bueltatzeko.</a>
                </div>
                </div>
                </div>
                </div>
          </html>

  	</BODY> 	 
</HTML>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Beiros - Gure orrialde pertsonala</title>
    <link href='http://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/flexslider.css" rel="stylesheet" >
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/queries.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    
                </ul>
              </div>
            </div>
          </div>
         
        </footer>
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/waypoints.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/scripts.js"></script>
        <script src="js/jquery.flexslider.js"></script>
        <script src="js/modernizr.js"></script>
        <script src="js/LoginKonprobatu.js"></script>
        <script src="js/DatubaseraKonektatuBotoia.js"></script>
        <script src="js/FormularioaBalioztatu.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
      </body>
    </html>
